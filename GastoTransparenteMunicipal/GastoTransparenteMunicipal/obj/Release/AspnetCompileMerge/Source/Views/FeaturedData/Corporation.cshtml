@model GastoTransparenteMunicipal.Models.CorporacionModel
@{
    ViewBag.Title = "Corporation";
}

<h2>Corporation</h2>

<svg width="1080" height="425"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://unpkg.com/d3-sankey@0.6"></script>
<style>
    /* set the CSS */
    .tooltip {
        background: white;
        box-shadow: 0 0 5px #999999;
        color: #333;
        display: none;
        font-size: 14px;
        font-family: Roboto;
        font-weight: 300;
        left: 130px;
        padding: 0px;
        position: absolute;
        text-align: center;
        top: 95px;
        width: 250px;
        border-radius: 4px;
        border: 1px solid #95989A;
        box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.16);
        z-index: 10;
    }


    .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .07;
    }

        .link:hover {
            stroke-opacity: .25 !important;
        }

    .node rect {
        cursor: pointer;
        fill-opacity: .9;
        shape-rendering: crispEdges;
    }

    .node text {
        pointer-events: none;
        text-shadow: 0 0px 0 #fff;
    }
</style>
<script>

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var formatNumber = d3.format(""),
        format = function(d) { return formatNumber(d) + " Millones de pesos"; },
        color = d3.scaleOrdinal(d3.schemeCategory20);

    var sankey = d3.sankey()
        .nodeWidth(30)
        .nodePadding(10)
        .extent([[1, 1], [width - 1, height - 6]]);

    var link = svg.append("g")
        .attr("class", "links")
        .attr("fill", "none")
        .attr("stroke", "#000")
        .attr("stroke-opacity", 0.1)
      .selectAll("path");

    var node = svg.append("g")
        .attr("class", "nodes")
        .attr("font-family", "Roboto")
        .attr("font-size", 16)
      .selectAll("g");

    // Define the div for the tooltip
    var tooltip = d3.select('body')            // NEW
      .append('div')                             // NEW
      .attr('class', 'tooltip');                 // NEW

    tooltip.append('div')
      .attr('class', 'source_title')
      .style("text-align", "left")
      .style("background", "#EFEFEF")
      .style("padding", "6px");

    tooltip.append('div')
      .attr('class', 'name')
      .style("font-size", "18px")
      .style("text-align", "right")
      .style("padding", "6px");

    tooltip.append('div')
      .attr('class', 'target_title')
      .style("text-align", "left")
      .style("background", "#EFEFEF")
      .style("padding", "6px");

    tooltip.append('div')                        // NEW
      .attr('class', 'name2')
      .style("text-align", "right")
      .style("padding", "6px")
      .style("font-size", "18px");

    tooltip.append('div')
      .attr('class', 'value_title')
      .style("text-align", "left")
      .style("background", "#EFEFEF")
      .style("padding", "6px");

    tooltip.append('div')                        // NEW
      .attr('class', 'value')
      .style("text-align", "right")
      .style("padding", "6px")
      .style("font-size", "18px");


    var tooltip2 = d3.select('body')            // NEW
      .append('div')                             // NEW
      .attr('class', 'tooltip');

    tooltip2.append('div')                        // NEW
      .attr('class', 'nodo_tipo')
      .style("text-align", "left")
      .style("background", "#6798C1")
      .style("padding", "6px")
      .style("color","#fff")
      .style("font-size", "12px");

    tooltip2.append('div')                        // NEW
      .attr('class', 'nodo_tipo_v')
      .style("text-align", "right")
      .style("background", "#5f7188")
      .style("padding", "6px")
      .style("color","#fff")
      .style("font-size", "12px");

    tooltip2.append('div')                        // NEW
      .attr('class', 'nodo_nombre')
      .style("text-align", "left")
      .style("background", "#6798C1")
      .style("padding", "6px")
      .style("color","#fff")
      .style("font-size", "12px");

    tooltip2.append('div')                        // NEW
      .attr('class', 'nodo_nombre_v')
      .style("text-align", "right")
      .style("background", "#5f7188")
      .style("padding", "6px")
      .style("color","#fff")
      .style("font-size", "12px");

    tooltip2.append('div')                        // NEW
      .attr('class', 'nodo_monto_t')
      .style("text-align", "left")
      .style("background", "#6798C1")
      .style("padding", "6px")
      .style("color","#fff")
      .style("font-size", "12px");

    tooltip2.append('div')                        // NEW
      .attr('class', 'monto_t')
      .style("text-align", "right")
      .style("background", "#5f7188")
      .style("padding", "6px")
      .style("font-size", "12px")
      .style("color","#fff");

    tooltip2.append('div')                        // NEW
      .attr('class', 'sugerencia')
      .style("text-align", "right")
      .style("background", "#efefef")
      .style("padding", "6px")
      .style("font-size", "14px")
      .style("color","#f0c241");


    var currentMunicipality = "RECOLETA";
    var url = "/" + currentMunicipality + "/FeaturedData/CorporationAjax";
    d3.json(url, function (error, energy) {
        if (error) throw error;

        sankey(energy);

        link = link
        .data(energy.links)
        .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.sankeyLinkHorizontal())
            .attr("id", function(d,i){
            d.id = i;
            return "link-"+i;
            })
            .attr("stroke-width", function(d) { return Math.max(1, d.width); });


        link.on('mouseover', function(d) {
            tooltip.select('.source_title').html("Origen:");                // NEW
            tooltip.select('.name').html(d.source.name);                // NEW
            tooltip.select('.target_title').html("Destino:");                // NEW
            tooltip.select('.name2').html(d.target.name);
            tooltip.select('.value_title').html("Monto aportado:");                // NEW
            tooltip.select('.value').html(format(d.value));                // NEW
            tooltip.style('display', 'block');                          // NEW
          });                                                           // NEW

        link.on('mouseout', function() {                              // NEW
            tooltip.style('display', 'none');                           // NEW
          });

        link.on('mousemove', function(d) {                            // NEW
            tooltip.style('top', function(d) {
                    if (d3.event.layerY >= 250) {return (d3.event.layerY - 210) + 'px'}
                    else    { return (d3.event.layerY + 10) + 'px' };
                  });
            tooltip.style('left', function(d) {
                    if (d3.event.layerX >= 400) {return (d3.event.layerX - 310) + 'px'}
                    else    { return (d3.event.layerX + 10) + 'px' };
                  });
                  });

        node = node
        .data(energy.nodes)
        .enter().append("g")
        .attr("class", "node")
        .on("click",highlight_node_links);

        node.append("rect")
            .attr("x", function(d) { return d.x0; })
            .attr("y", function(d) { return d.y0; })
            .attr("height", function(d) { return d.y1 - d.y0; })
            .attr("width", function(d) { return 30; })
            .attr("fill", function(d) {
                if(d.name == "Aportes del gobierno central") return "#4c617b";
                if(d.name == "Aporte del municipio") return "#0D2B50";
                if(d.name == "Aporte de privados") return "#8D99A8";
                if(d.name == "Corporacion de Salud") return "#EA1C73";
                if(d.name == "Corporacion de Educacion") return "#9B5CB5";
                if(d.name == "Corporacion de Deportes") return "#57BE61";
                if(d.name == "Corporacion de Cultura") return "#F0254C";
            })
            .attr("stroke", "#ffffff");

        node.append("text")
            .attr("x", function(d) { return d.x0 - 20; })
            .attr("y", function(d) { return (d.y1 + d.y0 - 15 ) / 2; })
            .attr("dy", "0.9em")
            .attr("text-anchor", "end")
            .text(function(d) { return d.name2; })
        .filter(function(d) { return d.x0 < width / 2; })
            .attr("x", function(d) { return d.x1 + 20; })
            .attr("text-anchor", "start");

        node.selectAll("text")
        .style("font-size", "16px")
        .style("font-weight", "300");

        node.append("text")
            .attr("class","nodeValue")
            .text(function(d) { return d.name2 + "\n" + format(d.value); });

        ///align vertically???
        node.selectAll("text.nodeValue")
        .attr("x", function(d) { return d.x0+15; })
        .attr("y", function(d) { return (d.y1 + d.y0 +5) / 2; })
        .text(function (d) { return formatNumber(d.value); })
        .style("fill", "white")
        .style("font-size", "10px")
        .style("text-shadow", " 0 0 0 #fff")
        .attr("text-anchor", "middle");

        node.on('mouseover', function(d) {
        tooltip2.select('.nodo_tipo').html("Tipo:");                // NEW
        tooltip2.select('.nodo_tipo_v').html(d.name2);                // NEW
        tooltip2.select('.nodo_nombre').html("Nombre:");                // NEW
        tooltip2.select('.nodo_nombre_v').html("Corporacion de Ayuda XXXXXXXXX");
        tooltip2.select('.nodo_monto_t').html("Monto:");                // NEW
        tooltip2.select('.monto_t').html(format(d.value));
        tooltip2.select('.sugerencia').html("click en el nodo para ver distribución");                // NEW
        tooltip2.style('display', 'block');                          // NEW
        });                                                           // NEW

        node.on('mouseout', function() {                              // NEW
            tooltip2.style('display', 'none');                           // NEW
        });

        node.on('mousemove', function(d) {                            // NEW
            tooltip2.style('top', function(d) {
                    if (d3.event.layerY >= 250) {return (d3.event.layerY - 30) + 'px'}
                    else    { return (d3.event.layerY + 10) + 'px' };
                });
            tooltip2.style('left', function(d) {
                    if (d3.event.layerX >= 400) {return (d3.event.layerX - 310) + 'px'}
                    else    { return (d3.event.layerX + 10) + 'px' };
                });
                });


        function highlight_node_links(node,i){

            var remainingNodes=[],
                nextNodes=[];

            var stroke_opacity = 0;
            if( d3.select(this).attr("data-clicked") == "1" ){
              d3.select(this).attr("data-clicked","0");
              stroke_opacity = 0.07;
            }else{
              d3.select(this).attr("data-clicked","1");
              stroke_opacity = 0.25;
            }

            var traverse = [{
                              linkType : "sourceLinks",
                              nodeType : "target"
                            },{
                              linkType : "targetLinks",
                              nodeType : "source"
                            }];

            traverse.forEach(function(step){
              node[step.linkType].forEach(function(link) {
                remainingNodes.push(link[step.nodeType]);
                highlight_link(link.id, stroke_opacity);
              });

              while (remainingNodes.length) {
                nextNodes = [];
                remainingNodes.forEach(function(node) {
                  node[step.linkType].forEach(function(link) {
                    nextNodes.push(link[step.nodeType]);
                    highlight_link(link.id, stroke_opacity);
                  });
                });
                remainingNodes = nextNodes;
              }
            });
          }

        function highlight_link(id,opacity){
            d3.select("#link-"+id).style("stroke-opacity", opacity);
        }

    });
</script>