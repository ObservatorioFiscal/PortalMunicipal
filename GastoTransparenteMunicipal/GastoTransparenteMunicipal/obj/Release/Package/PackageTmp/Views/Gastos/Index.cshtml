
@{
    ViewBag.Title = "Gastos";
}

<style>
    .numero1 {
        position: relative;
    }

        .numero1 .numero2 {
            width: 100%;
            vertical-align: middle;
            position: absolute;
            top: 8px;
            border-right: 2px solid #dadada;
            border-left: 2px solid #dadada;
        }

            .numero1 .numero2 hr {
                border-color: #ffffff;
            }

        .numero1 .numero3 {
            position: absolute;
            top: 0px;
            width: 100%;
            padding: 0px 10px;
        }

    .flecha {
        color: white;
        font-size: 31px;
    }

    .seleccionadomiga {
        border-bottom: 4px solid #F1C330 !important;
    }

    .migapan {
        padding: 5px;
        display: inline-block;
    }

    .cadamiga {
        cursor: pointer;
        display: inline-block;
    }

        .cadamiga:hover .contenmiga {
            background-color: #F1C330;
            color: red;
        }

            .cadamiga:hover .contenmiga span {
                color: white;
            }

        .cadamiga:hover .flecha {
            border-left: 24px solid #F1C330;
        }

        .cadamiga .contenmiga {
            background-color: rgb(245, 249, 255);
            display: inline-block;
            float: left;
            height: 44px;
            border-bottom: 4px solid transparent;
        }

        .cadamiga .flecha2 {
            color: white;
            width: 0;
            height: 0;
            border-top: 24px solid transparent;
            border-left: 24px solid white;
            display: inline-block;
            vertical-align: middle;
            border-bottom: 20px solid transparent;
        }

        .cadamiga .flecha {
            color: white;
            width: 0px;
            height: 0;
            border-top: 24px solid transparent;
            border-left: 24px solid rgb(245, 249, 255);
            display: inline-block;
            border-bottom: 20px solid transparent;
            margin: 0;
            padding: 0;
            float: left;
        }

        .cadamiga .flechContenido {
            display: inline-block;
            padding: 0px 20px;
            vertical-align: middle;
        }

            .cadamiga .flechContenido span {
                color: #34495C
            }


    .node {
        border: solid 1px white;
        position: absolute;
        display: flex;
        text-align: left;
        justify-content: space-between;
        flex-direction: column;
        color: #4e4e4e;
        font-size: 14px;
        overflow: hidden;
        cursor: pointer;
    }

        .node:hover {
            overflow: hidden;
            background-color: #F1C330 !important;
        }

    .textos {
        padding: 10px;
        text-anchor: middle;
        pointer-events: none;
        font-family: Roboto;
        color: white;
        font-size: 24px;
        top: 0px;
        font-weight: 400;
        padding-bottom: 1px;
        margin-right: 20px;
    }

    .textos2 {
        text-anchor: middle;
        pointer-events: none;
        font-family: Roboto;
        color: white;
        font-size: 16px;
        top: 0px;
        font-weight: 300;
        display: block;
    }

    .tooltiptremap {
        width: 300px;
        position: absolute;
        height: auto;
        background-color: white;
        border-radius: 4px;
        border: 1px solid #95989A;
        pointer-events: none;
        top: 0;
        visibility: hidden;
    }

        .tooltiptremap .titulo {
            padding: 10px 10px 0px 10px;
            font-size: 26px;
            font-weight: 400;
            margin: 0px;
            background-color: #EDF1F2;
        }

        .tooltiptremap .conten {
            text-align: left;
            padding: 10px 10px 0px 10px;
            margin: 0;
            font-size: 16px;
        }

        .tooltiptremap .conten2 {
            padding: 0px 10px;
            margin: 0px;
            text-align: left;
            font-size: 24px;
        }

        .tooltiptremap .descrip {
            padding: 0px 10px 10px 10px;
            font-size: 12px;
            margin: 0px;
            background-color: #EDF1F2;
        }

        .tooltiptremap .text {
            text-align: left;
            font-size: 12px;
            padding: 0px 0px 20px 10px;
            margin: 0;
        }

        .tooltiptremap .mensaje {
            text-align: left;
            font-size: 11px;
            background: #fbfbfb;
            padding: 10px;
            margin: 0px 10px 10px 10px;
            color: #f1c330;
        }

    .Titulo {
        font-size: 30px;
        font-weight: 400;
        margin-top: 10px;
    }

        .Titulo span {
            font-size: 20px;
            font-weight: 300;
        }

    .seleccionc {
        border-bottom: 4px solid transparent;
        cursor: pointer;
        color: #314b6a;
        font-weight: 400;
        font-size: 22px;
    }

    .seleccioncambio {
        color: #F1C330;
        border-bottom: 4px solid #F1C330 !important;
    }
</style>




<input type="hidden" id="IDPAPA" name="IDPAPA" value="0" />
<input type="hidden" id="NOMBREPAPA" name="NOMBREPAPA" value="" />
<input type="hidden" id="FUNCECONO" name="FUNCECONO" value="" />
<input type="hidden" id="NIVEL" name="NIVEL" value="1" />

<div class="row seccion-destado">
    <div class="col">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1>
                        Gastos
                        <small>
                            del
                            <span class="muntotal">Municipio Total</span>
                        </small>

                        <small>
                            del año:
                            <span class="select">
                                @Html.DropDownList("name", (SelectList)ViewBag.Anos, null, new { @class = "muntotal", @id = "ano" })
                            </span>
                        </small>
                    </h1>
                </div>
            </div>
            <div id="Bienvenida" class="row padding-Div text-center">
                <div class="col-md-12">
                    <h4>Elige un punto de partida</h4>
                    <p>Puedes seleccionar una perspectiva de inicio, ya sea por área o por cuenta, pero luego también puedes cruzarlas, estando en un área, y conocer sus cuentas y viceversa</p>
                </div>
                <div class="col-md-6">
                    <div class="cubo">
                        <h3>¿En qué se gasta?</h3>
                        <p>Explora el énfasis del gasto municipal entre las distintas áreas del Municipio: Educación, Salud, Adm. y Servicios Municipales y Cementerios.</p>
                        <p>
                            <br />
                            <a href="#" onclick="dibujar(1); return false;" class="btn">Área</a>
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="cubo">
                        <h3>¿Cómo se gasta?</h3>
                        <p>Revisa cómo se distribuyeron los recursos municipales entre las distintas cuentas de gasto: Personal, compras, aportes a organizaciones o la inversión.</p>
                        <p>
                            <br />
                            <a href="#" onclick="dibujar(0); return false;" class="btn">Cuentas</a>
                        </p>
                    </div>
                </div>
            </div>

            <div id="Grafico" class="hidden row padding-Div">
                <div class="col-md-12">
                    <div id="miga">
                    </div>

                    <p class="text-right margin-cero">
                        Ver detalle por:
                        <span id="cuuuu" class="seleccionc seleccioncambio" onclick="cambio('CUENTA');return false;"> Cuenta </span> /
                        <span id="arrrr" class="seleccionc" onclick="cambio('AREA');return false;"> Area </span>
                    </p>
                    <div id="chart_div" style="min-height:400px;" oncontextmenu="return false;"></div>
                    <div class="Titulo numero1">
                        <div class="numero2">

                            <hr />
                        </div>
                        <div class="numero3" id="Titulo">
                            Gastos <span> (15.000 millones)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row padding-Div"></div>
        </div>
    </div>
</div>





@section Scripts{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.0.0/d3.js"></script>
    <script src="~/Scripts/select.js"></script>
    <script>
        var idpapa = "0";
        var ID = "0";
        var nombretipo = "";
        var VALUEX = 0;
        var className = "Gastos";
        var nivel = 1;
        function classes(data) {
            var classes = [];

            var colores = [
                "rgba(13,43,80,1)",
                "rgba(13,43,80,0.95)",
                "rgba(13,43,80,0.90)",
                "rgba(13,43,80,0.85)",
                "rgba(13,43,80,0.80)",
                "rgba(13,43,80,0.75)",
                "rgba(13,43,80,0.70)",
                "rgba(13,43,80,0.65)",
                "rgba(13,43,80,0.60)"
            ]
            var i = 0;
            function recurse(name, node) {
                if (node.children) node.children.forEach(function (child) {
                    recurse(node.name, child, null);
                });
                else {
                    i++;
                    if (i > 7){
                        i = 7;
                    }
                    classes.push({
                        packageName: name,
                        className: node.name,
                        fondo: colores[i],
                        value: node.size,
                        tipo: node.tipo,
                        valueTooltip1: node.valueTooltip1,
                        valueTooltip2: node.valueTooltip2,
                        porcentaje1: node.porcentaje1,
                        porcentaje2: node.porcentaje2,
                        descripcion: node.descripcion,
                        id:node.id
                    });
                }
            }
            recurse(null, data);
            return {
                children: classes
            };
            }
        function drawChart(aux)
        {
            VALUEX = 0;
            var IDANO = $("#ano").val();
            var IDPAPA = $("#IDPAPA").val();
            var FUNCECONO = $("#FUNCECONO").val();
            var NombrePapa = $("#NOMBREPAPA").val();
            var margin = { top: 10, right: 10, bottom: 10, left: 10 };
            var width = $(".container").width();
            width = (width < 400) ? 400 : width;
            var height = width / 3;
            var treemap = d3.layout.treemap().size([width, height]).sticky(true).mode("squarify").ratio(5).round(true).sort(function (a, b) { return a.value - b.value; }).value(function (d) { return d.value; });
            var div = d3.select("body").select("#chart_div").append("div").attr("id", "treeChart").style("position", "relative").style("height", (height + margin.top + margin.bottom) + "px").style("top", margin.top + "px");
            var tooltip = d3.select("body").append("div").attr('class', 'tooltiptremap');
            var url = "@Url.Action("JsonGastoNivelX", "Gastos")" + "?tipo=" + FUNCECONO + "&idNivel=" + nivel + "&profundidad=" + IDPAPA + "&year=" + IDANO ;
            d3.json(url, function (error, data) {
                var Format = data.Format;
                VALUEX = data.TotalSuma;
                var Formato;
                var node = div.selectAll(".node")
                    .data(treemap.nodes(classes(data, null)))
                    .enter().append("div")
                    .attr("class", "node")
                    .attr("Id", function (d) {
                        return d.id;
                    })
                    .call(position)
                    .style("background", function (d) {
                        Formato = d.tipo;
                        return d.fondo;
                    })
                    .on("mouseover", function (d) {
                        tooltip.append("p").attr("id", "texto3").attr("class", "titulo").text(d.className);
                        tooltip.append("p").attr("id", "texto33").attr("class", "descrip").text(d.descripcion);
                        tooltip.append("p").attr("id", "texto1").attr("class", "conten").text("Gastado:");
                        tooltip.append("p").attr("id", "texto11").attr("class", "conten2").text("$" + d.valueTooltip1 + " millones");
                        var aux1 = "Equivale al " + d.porcentaje1 + "% del gasto de " + NombrePapa + ".";
                        var aux2 = "Equivale al " + d.porcentaje2 + "% del presupuesto de " + NombrePapa + ".";
                        if (NombrePapa == "Gastos") {
                            aux1 = "Equivale al " + d.porcentaje1 + "% del gasto total del municipio";
                            aux2 = "Equivale al " + d.porcentaje2 + "% del presupuesto total del municipio";
                        }
                        tooltip.append("p").attr("id", "texto34").attr("class", "text").text(aux1);
                        tooltip.append("p").attr("id", "texto2").attr("class", "conten ").text("Presupuestado:");
                        tooltip.append("p").attr("id", "texto22").attr("class", "conten2 ").text("$" + d.valueTooltip2 + " millones");
                        tooltip.append("p").attr("id", "texto35").attr("class", "text ").text(aux2);
                        tooltip.append("p").attr("id", "texto36").attr("class", "mensaje").text("* Click en bloque para ver detalle");
                        tooltip.style("visibility", "visible");
                    })
                    .on("mousemove", function (d) {
                        tooltip.style("top", function (d) {
                            if (d3.event.pageY > 350) {
                                return (d3.event.pageY - 360) + "px"
                            }
                            else {
                                return (d3.event.pageY - 10) + "px"
                            }
                        });
                        tooltip.style("left", function (d) {
                            if (d3.event.pageX > 300) {
                                return (d3.event.pageX - 300) + "px"
                            }
                            else {
                                return (d3.event.pageX - 10) + "px"
                            }
                        });
                    })
                    .on("mouseout", function () {
                        tooltip.style("visibility", "hidden");
                        $("#texto1").remove();
                        $("#texto2").remove();
                        $("#texto3").remove();
                        $("#texto11").remove();
                        $("#texto22").remove();
                        $("#texto3").remove();
                        $("#texto33").remove();
                        $("#texto34").remove();
                        $("#texto35").remove();
                        $("#texto36").remove();
                        return 1;
                    })
                    .on("click", function (d) {
                        nivel = document.getElementById("NIVEL").value;
                        if (nivel < "4") {
                            $("#texto1").remove();
                            $("#texto2").remove();
                            $("#texto3").remove();
                            $("#texto11").remove();
                            $("#texto22").remove();
                            $("#texto3").remove();
                            $("#texto33").remove();
                            $("#texto34").remove();
                            $("#texto35").remove();
                            $("#texto36").remove();
                            tooltip.style("visibility", "hidden");
                            idpapa = document.getElementById("IDPAPA").value;
                            nombretipo = document.getElementById("FUNCECONO").value;

                            nivel = parseInt(nivel) + 1;
                            className = d.className;
                            ID = d.id;
                            document.getElementById("NIVEL").value = nivel;
                            document.getElementById("NOMBREPAPA").value = d.className;
                            document.getElementById("IDPAPA").value = d.id;
                            drawChart(0);
                            document.getElementById("treeChart").remove();
                        };
                    })
                node.append("text").attr("class", "textos").text(function (d) {
                    if (d.className != null) {
                        var largo = d.className.length;
                        var x = d.dx;
                        var y = d.dy;
                        if (((largo * 1) < d.dx) && (d.dy > 40)) {
                            return d.children ? null : d.className;
                        }
                        else {
                        }
                    }
                }).append("text").attr("class", "textos2").text(function (d) {
                    if (d.value != null) {
                        var largo = String(d.value).length;
                        var x = d.dx;
                        var y = d.dy;
                        if (((largo / 3) < d.dx) && (d.dy > 80)) {
                            return d.children ? null : "$" + puntos(d.value) +" millones";
                        }
                        else {
                        }
                    }
                });
                $("#cuuuu").text("");
                $("#arrrr").text("");
                switch (Format) {
                    case "1 ":
                        if (Formato == "CUENTA") {
                            $("#cuuuu").text("Cuenta");
                        }
                        else {
                            $("#arrrr").text("Area");
                        }
                        break;
                    case "0 ":
                        $("#cuuuu").text("Cuenta");
                        $("#arrrr").text("Area");
                        break;
                    case "3 ":
                        if (Formato == "CUENTA") {
                            $("#cuuuu").text("Cuenta");
                        }
                        else {
                            $("#arrrr").text("Area");
                        }
                        break;
                }
                if (aux == 0) {
                    var stringgg = document.getElementById("miga").innerHTML;
                    stringgg = stringgg.replace("seleccionadomiga", "")

                    document.getElementById("miga").innerHTML = stringgg + '<div class="cadamiga" id="miga' + nivel + '"><a onclick="devolver(' + nivel + ',' + ID + ',\'' + FUNCECONO + '\',' + VALUEX + ',\'' + className + '\')">  <div class="contenmiga seleccionadomiga"><div class="flecha2"></div><div class="flechContenido"><span>' + className + '</span></div></div><div class="flecha"></div></a></div>';
                }
                if (Formato == "CUENTA") {
                    $("#cuuuu").removeClass("seleccioncambio");
                    $("#arrrr").removeClass("seleccioncambio");
                    $("#cuuuu").addClass("seleccioncambio");
                }
                else {
                    $("#cuuuu").removeClass("seleccioncambio");
                    $("#arrrr").removeClass("seleccioncambio");
                    $("#arrrr").addClass("seleccioncambio");
                }
                document.getElementById("FUNCECONO").value = Formato;
                document.getElementById("Titulo").innerHTML = "<p class='text-center'><span style='background-color:white'>" + className + "( $" + puntos(VALUEX) + " mill) </span></p>";

        });
        function position() {
            this.style("left", function (d) { return d.x + "px"; })
                .style("top", function (d) { return d.y + "px"; })
                .style("width", function (d) { return Math.max(0, d.dx - 1) + "px"; })
                .style("height", function (d) { return Math.max(0, d.dy - 1) + "px"; });
        }
    }
    function devolver(nivell, Idpapa, funci, valor, nombre) {
        $("#miga" + nivell).find(".contenmiga").addClass("seleccionadomiga");
        var i = nivell + 1;
        for (i; i < 5; i++) {
            $("#miga"+i).remove();
        }
        document.getElementById("NIVEL").value = (nivell);
        nivel = nivell;
        className = nombre;
        document.getElementById("NOMBREPAPA").value = nombre;
        document.getElementById("treeChart").remove();
        document.getElementById("IDPAPA").value = Idpapa;
        document.getElementById("FUNCECONO").value = funci;
        drawChart(1);
    }

    function cambio(aux) {
        $("#FUNCECONO").val(aux);
        document.getElementById("treeChart").remove();
        drawChart(1);
        if (aux == "CUENTA") {
            $("#cuuuu").removeClass("seleccioncambio");
            $("#arrrr").removeClass("seleccioncambio");
            $("#cuuuu").addClass("seleccioncambio");
        }
        else {
            $("#cuuuu").removeClass("seleccioncambio");
            $("#arrrr").removeClass("seleccioncambio");
            $("#arrrr").addClass("seleccioncambio");

        }
    }

    $(document).ready(function () {
        $("select").resizeselect();
        $(".destacado").hover(
            function () {
                $(".destacado").css("background-color", "#f5f9ff");
                $("#destacado-barra").removeClass("hidden");
                $(".borde-menu").css("border-bottom", "1px solid");

            }, function () {
                $(".destacado").css("background-color", "#ffffff");
                $("#destacado-barra").addClass("hidden");
                $(".borde-menu").css("border-bottom", "0px");
            }
        );

        $("#ano").change(function () {
            $("#Grafico").fadeOut(750, function () {
                $("#Bienvenida").fadeIn(750, function () {
                });
            });
            $("#IDPAPA").val("0");
            $("#NOMBREPAPA").val("Gastos");
            $("#NIVEL").val("1");
            idpapa = "0";
            ID = "0";
            nombretipo = "";
            className = "Gastos";
            nivel = 1;
            $("#chart_div").empty();
            $("#miga").empty();
        });
    });

    function dibujar(aux) {

        document.getElementById("FUNCECONO").value = ((aux == 0) ? "CUENTA" : "AREA");
        drawChart(0);
        $("#Bienvenida").fadeOut(500, function () {
            $("#Grafico").fadeIn(500, function () {
            });
        });
    }

    </script>

}