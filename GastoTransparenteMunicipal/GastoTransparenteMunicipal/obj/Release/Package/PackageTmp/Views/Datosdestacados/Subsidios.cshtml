
@{
    ViewBag.Title = "Subsidios";
}

<div class="row seccion-destado">
    <div class="col">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1>
                        Subsidios
                        <small>
                            del
                            <span class="muntotal">Municipio Total</span>
                        </small>

                        <small>
                            del año:
                            <span class="select ">
                                @Html.DropDownList("name", (SelectList)ViewBag.Anos, null, new { @class = "muntotal", @id = "ano" })
                                @*<select id="ano">
                                        <option value="2017">2017 a Junio</option>
                                        <option value="2016">2016</option>
                                        <option value="2015">2015</option>
                                        <option value="2014">2014</option>
                                        <option value="2013">2013</option>
                                    </select>*@
                            </span>
                        </small>
                    </h1>
                    <p>Las compras del municipio representan un 10% del total de gasto realizado a julio de 2017, los montos constituyen los compromisos anuales adquiridos por el municipio con cada proveedor.</p>
                </div>
            </div>

            <div class="row padding-Div-top">
                <div class="col-md-12">
                    <h2>Montos por clasificacion de subsidios</h2>
                </div>
                <div class="col-md-12">
                    <div class="row" id="container">
                        <div class="col-md-6 align-self-center" id="chart"></div>
                        <div class="col-md-1"></div>
                        <div class="col-md-5 align-self-center" id="lateralPanel"></div>
                    </div>
                </div>
                <div id="tooltip" class="hidden">
                    <p><span class="tooltipTitle">Clasificacion: </span><span id="clasificacion"></span></p>
                    <p><span class="tooltipTitle">Monto: </span><span id="monto"></span></p>
                </div>
            </div>



            <div class="row padding-Div">
                <div class="col-md-12">
                    <h2>Buscar Beneficiarios</h2>
                    <p>Cuál es el beneficiario que buscar, utiliza nuestro buscador para saber si recibió recursos municipales:<br></p>
                </div>
                <div class="col-md-12">
                    <input id="buscaSubsidio" onchange="filter(this.value)" onkeyup="filter(this.value)" type="text" class="form-control" placeholder="Ingrese el nombre del proveedor">
                </div>
                <div class="col-12">
                    <div class="row celda">
                    </div>
                    <div id="tabla" class="row muntotal celda">
                        <div class="col-8"><h6><b>Proveedor</b></h6></div>
                        <div class="col-4"><h6><b>Monto millones $</b></h6></div>
                    </div>

                    <div id="scrollbar1">
                        <div class="scrollbar"><div class="track"><div class="thumb"><div class="end"></div></div></div></div>
                        <div class="viewport">
                            <div class="overview" id="listapapa">
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>


@section Scripts{
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/tinyscrollbar/2.4.2/jquery.tinyscrollbar.min.js"></script>
    <script src="~/Scripts/select.js"></script>
    <script src="~/Scripts/FeaturedData/SubsidyBubbleChart.js"></script>
    <script>
        function filter(element) {
            var text = element.toUpperCase();
            console.log(text);
            var listapapa = $("#listapapa")[0];
            if (text != "") {
                for (i = 0; i < listapapa.children.length; i++) {
                    var hijo = listapapa.children[i];
                    var hijotext = hijo.children[0].outerText.toUpperCase();
                    if (!hijotext.includes(text)) {
                        hijo.hidden = true;
                    }
                    else {
                        hijo.hidden = false;
                    }
                }
                var $scrollbar5 = $("#scrollbar1");
                $scrollbar5.tinyscrollbar();
                var scrollbar5 = $scrollbar5.data("plugin_tinyscrollbar")
                scrollbar5.update();
            }
            else {
                for (i = 0; i < listapapa.children.length; i++) {
                    var hijo = listapapa.children[i];
                    hijo.hidden = false;
                }
            }
        }
        function llenarCirculos(diameter) {
            var diameterWidth = Math.round($(window).width() * (1 / 2));
            var diameterHeigth = diameterWidth * (2 / 3);
            $.ajax({
                cache: false,
                async: false,
                type: 'POST',
                data: {
                    year: $("#ano").val()
                },
                url: '@Url.Action("SubsidyAjaxNivel1", "FeaturedData")',
                dataType: 'json',
                success: function (result) {
                    $("#chart").empty();
                    $("#lateralPanel").empty();
                    drawChart(result, diameterWidth, diameterHeigth);
                }
            });
        }

        function llenarTabla() {
            //$("#listapapa").remove();
            $.ajax({
                cache: false,
                async: false,
                type: 'POST',
                data: {
                    year: $("#ano").val()
                },
                url: '@Url.Action("SubsidyChartNivel2", "FeaturedData")',
                dataType: 'json',
                success: function (data) {
                    $.each(data, function (index, item) {
                        $("#listapapa").append(nuevoPapa(item));
                    });
                    $('#scrollbar1').tinyscrollbar();
                }
            });
        };

        function verDetalle(aux) {
            if ($("#item-" + aux).children('.col-9').children('span').hasClass("icon-Recurso6")) {
                $(".icon-Recurso6").addClass("icon-Recurso5").removeClass("icon-Recurso6");
                $(".celda").removeClass("destacadocolor");
                $(".hijotabla").remove();
            }
            else {
                $(".celda").removeClass("destacadocolor");
                $("#item-" + aux).addClass("destacadocolor");
                $(".icon-Recurso6").addClass("icon-Recurso5").removeClass("icon-Recurso6");
                $("#item-" + aux).children('.col-9').children('span').removeClass("icon-Recurso5").addClass("icon-Recurso6");
                $(".hijotabla").remove();
                $.ajax({
                    cache: false,
                    async: false,
                    type: 'POST',
                    data: {
                        IdNivel2: aux
                    },
                    url: '@Url.Action("SubsidyChartNivel3", "FeaturedData")',
                    dataType: 'json',
                    success: function (data) {
                        $("#item-" + aux).append(nuevoHijoHeader(aux));
                        $.each(data, function (index, item) {
                            $("#table-" + aux).append(nuevoHijo(item));
                        });
                    }
                });
            }
        }

        function nuevoPapa(item) {
            return '\
                <div class="row celda"  onclick="verDetalle('+ item.IdNivel2 + ')" id="item-'+ item.IdNivel2 +'">\
                    <div class="col-9"><span class="md-24 muntotal icon-Recurso5"> </span>' + item.Nombre + '<small>(' + item.Categoria+')</small></div>\
                    <div class="col-3">$'+ item.Monto.toLocaleString() +'</div>\
                </div>\
                ';
        }

        function nuevoHijoHeader(aux) {
            return '\
                    <div class="col-12 hijotabla">\
                        <div class="row">\
                            <table class="table">\
                                <thead>\
                                    <tr>\
                                        <th>Fecha Decreto</th>\
                                        <th>Beneficiario</th>\
                                        <th>Monto</th>\
                                    </tr>\
                                </thead>\
                                <tbody id="table-'+aux+'">\
                                </tbody>\
                            </table>\
                        </div>\
                    </div>\
                    ';
        }
        function nuevoHijo(item) {
            return '\
                    <tr>\
                        <td> 19/04/2016 </td>\
                        <td> '+ item.Nombre +' </td>\
                        <td> $'+ item.Monto.toLocaleString() +' </td>\
                    </tr>\
                    ';
        }


        $(document).ready(function () {
            $("select").resizeselect();
            llenarCirculos();
            llenarTabla();
        });
    </script>
}