@using Core;
    ViewBag.Title = "Proveedores";
}

<div class="row seccion-destado">
    <div class="col">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1>
                        Proveedores
                        <small>
                            del
                            <span class="select">
                                <select id="origenData">
                                    <option value="@OrigenData.MunicipioTotal">Municipio Total</option>
                                    <option value="@OrigenData.Adm">Adm. y Serv. Municipal</option>
                                    <option value="@OrigenData.Salud">Salud</option>
                                    <option value="@OrigenData.Educacion">Educación</option>
                                    <option value="@OrigenData.Cementerio">Cementerio</option>
                                </select>
                            </span>
                        </small>

                        <small>
                            del año:
                            <span class="select">
                                @Html.DropDownList("name", (SelectList)ViewBag.Anos, null, new { @class = "muntotal", @id = "ano"})
                            </span>
                        </small>
                    </h1>
                    <p>Las compras del municipio representan un 10% del total de gasto realizado a julio de 2017, los montos constituyen los compromisos anuales adquiridos por el municipio con cada proveedor.</p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12" id="chartdiv">
                    <h2>Top 20 proveedores con mayores compras</h2>
                    <div id="chart"></div>
                </div>
            </div>
            <div id="tooltip" class="hidden">                
                
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h2>Buscar Proveedores</h2>
                    <p>Si el proveedor que buscas no está entre los 20 principales, usa el buscador que aparece a continuación:<br><br><br></p>
                </div>
            </div>
            <div class="muntotal input-group">
                <input id="buscaProveedor" onchange="filter(this)" type="text" class="" placeholder="Busca un proveedor">
                <div>
                    <button class="btn" type="button">buscar</button>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="row celda">
                    </div>
                    <div class="row muntotal celda">
                        <div class="col-6"><h6><b>Proveedor</b></h6></div>
                        <div class="col-3"><h6><b>Area</b></h6></div>
                        <div class="col-3"><h6><b>Monto millones $</b></h6></div>
                    </div>
                    <div id="listapapa"></div>
                    @*<div class="row celda destacadocolor" id="item-401">
                    <div class="col-9" onclick="verDetalle(401)">Compañia De Seguros Generales Pentasecurity S.A.</div>
                    <div class="col-3">$650.000.000</div>
                </div>
                <div class="row celda">
                    <div class="col-9">Compañia De Seguros Generales Pentasecurity S.A.</div>
                    <div class="col-3">$650.000.000</div>
                </div>*@
                </div>
            </div>

        </div>
    </div>
</div>

@section scripts{
    <script src="~/Scripts/select.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
    <script src="~/Scripts/FeaturedData/WordCloud.js"></script>

<script>

    function filter(element) {        
        var text = element.value.toUpperCase();      
        console.log(text);
        var listapapa = $("#listapapa")[0];  
        if (text != "") {
            for (i = 0; i < listapapa.children.length; i++) {
                var hijo = listapapa.children[i];
                var hijotext = hijo.children[0].outerText.toUpperCase();
                if (!hijotext.includes(text)) {
                    hijo.hidden = true;
                }
                else {
                    hijo.hidden = false;
                }
            }
        }
        else {
            for (i = 0; i < listapapa.children.length; i++) {
                var hijo = listapapa.children[i];               
                hijo.hidden = false;                
            }
        }
    }

    function change() {
        clearAll();
        init();        
    }

    function init() {
        drawChart
        drawChart();
        llenarTabla();
    }

    function clearAll() {
        $("#chart").html('');
        $("#listapapa").html('');            
        $("#hijotabla").remove();                   
    }

    function drawChart() {
        var url = "@Url.Action("Providers", "FeaturedData")";
        $.ajax({
            type: 'POST',
            data: {
                year: $("#ano").val(),
                origenData: 3//$("#origenData").val()
            },
            url: url,
            dataType: 'json',
            success: function (result) {
                drawWordCloud(result.monto, result.proveedor);
            }
        });
    }
    function llenarTabla() {
        //$("#listapapa").remove();
        $.ajax({
            cache: false,
            async: false,
            type: 'POST',
            data: {
                year: $("#ano").val(),
                origenData: 3//$("#origenData").val()
            },
            url: '@Url.Action("ProvidersTable", "FeaturedData")',
            data: {
                year: $("#ano").val(),
                origenData: $("#origenData").val()
            },
            dataType: 'json',
            success: function (data) {
                $.each(data, function (index, item) {
                    $("#listapapa").append(nuevoPapa(item));
                });
            }
        });
    };  

    function verDetalle(aux) {
            $("#item-" + aux).addClass("destacadocolor");
            $(".hijotabla").remove();
            $.ajax({
                cache: false,
                async: false,
                type: 'POST',
                data: {
                    idNivel1: aux,
                    origenData: 3//$("#origenData").val()
                },
                url: '@Url.Action("ProvidersDetalle", "FeaturedData")',
                dataType: 'json',
                success: function (data) {
                    $("#item-" + aux).append(nuevoHijoHeader(aux));
                    $.each(data, function (index, item) {
                        $("#table-" + aux).append(nuevoHijo(item));
                    });
                }
            });
        };

        function nuevoPapa(item) {
            return '\
            <div class="row celda" id="item-'+ item.IdNivel1 + '">\
                <div class="col-6" onclick="verDetalle('+ item.IdNivel1 + ')">' + item.Nombre + '</div>\
                <div class="col-3">$' + "" + '</div>\
                <div class="col-3">$'+ item.Monto.toLocaleString() + '</div>\
            </div>\
        ';
        }

        function nuevoHijoHeader(aux) {
            return '\
                    <div class="col-12 hijotabla" id = "hijotabla" >\
                        <div class="row">\
                            <table class="table">\
                                <thead>\
                                    <tr>\
                                        <th>Proveedor</th>\
                                        <th>OC - Glosa</th>\
                                        <th>Area</th>\
                                        <th>Monto</th>\
                                    </tr>\
                                </thead>\
                                <tbody id="table-'+ aux + '">\
                                </tbody>\
                            </table>\
                        </div>\
                    </div>\
                    ';
        }

        function nuevoHijo(item) {
            return '\
                    <tr>\
                        <td> '+ item.Nombre + ' </td>\
                        <td> '+ item.Glosa + ' </td>\
                        <td> '+ item.Area + ' </td>\
                        <td> $'+ item.Monto.toLocaleString() + ' </td>\
                    </tr>\
                    ';
        }

        function drawWordCloud(monto,proveedor) {

        var array_montos = monto;
        var array_texto = proveedor;
        var word_count = {};
        for (i = 0; i < array_montos.length; i++) {
            word_count[array_texto[i]] = Math.round(array_montos[i]/1);
        }

        var svg_location = "#chart";
        var width = $("#chartdiv").width();
        var height = width/3;

        var fill = d3.scale.category20();
        var word_entries = d3.entries(word_count);

        var xScale = d3.scale.linear()
            .domain([0, d3.max(word_entries, function (d) {
                return d.value;
            })
            ])
            .range([10, 100]);
        d3.layout.cloud().size([width, height])
            .timeInterval(20)
            .words(word_entries)
            .fontSize(function (d) { return xScale(+d.value); })
            .text(function (d) { return d.key; })
            .rotate(function () { return 0; })
            .font("Impact")
            .on("end", draw)
            .start();

        function draw(words) {
            d3.select(svg_location).append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + [width >> 1, height >> 1] + ")")
                .selectAll("text")
                .data(words)
                .enter().append("text")
                .style("font-size", function (d) { return xScale(d.value) + "px"; })
                .style("font-family", "Impact")
                .style("fill", function (d, i) { return "#1f77b4"; })
                .style("cursor", "pointer")
                .attr("text-anchor", "middle")
                .attr("id", function (d) { return d.key.replace(/ /g, ''); })
                .attr("monto", function (d) { return d.value.toLocaleString(); })
                .attr("class", "normal-text")
                .attr("onmouseover", "mouseover_text(event)")
                .attr("onmousemove", "mousemove_text(event)")
                .attr("onmouseout", "mouseout_text(event)")
                .attr("onclick", function (d) {
                    return "selectText('"+ d.key +"')";
                })
                .attr("transform", function (d) {
                    return "translate(" + [d.x, d.y] + ")rotate(" + 0 + ")";
                })
                .text(function (d) { return  d.key; });
        }

        d3.layout.cloud().stop();
        }

        function selectText(text) {
            $("#buscaProveedor").val('');
            $("#buscaProveedor").val(text);
        }

        function mouseover_text(event) {
            var tooltip = $("#tooltip");
            tooltip.css("left", (event.pageX + 20) + "px");
            tooltip.css("top", (event.pageY - 110) + "px");
            tooltip.select("#monto").text("Monto: $ " + event.srcElement.attributes.monto.nodeValue );
            tooltip.attr("class","");

            var id = event.srcElement.id;
            var texts = document.getElementsByClassName("normal-text");
            for (i = 0; i < texts.length; i++) {
                if (texts[i].id != id) {
                    texts[i].classList.add("change-color");
                }
            }
        }

        function mousemove_text(event) {
            mouseout_text(event);
            mouseover_text(event);
        }

        function mouseout_text(event) {
            var tooltip = $("#tooltip");
            tooltip.attr("class", "hidden");
            var circles = document.getElementsByClassName("normal-text");
            for (i = 0; i < circles.length; i++) {
                circles[i].classList.remove("change-color");
            }
        }

        $(document).ready(function () {            
            $("select").resizeselect();        
            init();
            $("#ano").attr("onchange", "change()");
            $("#origenData").attr("onchange", "change()");
        });
    </script>


}